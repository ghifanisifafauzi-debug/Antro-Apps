<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengukuran Antropometri Anak - Standar WHO</title>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.2.1/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
      body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
      .header-title { color: #2c3e50; font-weight: bold; text-align: center; margin-top: 20px; }
      .sub-title { text-align: center; color: #7f8c8d; margin-bottom: 30px; }
      .card-custom { border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: none; margin-bottom: 20px; }
      .result-box { padding: 15px; border-radius: 10px; margin-top: 10px; text-align: center; font-weight: bold; }
      .stunting { background-color: #ffcccc; color: #cc0000; }
      .normal { background-color: #d4edda; color: #155724; }
      .canvas-container { position: relative; height: 300px; width: 100%; }
    </style>
  </head>
  <body>

    <div class="container pb-5">
      <h2 class="header-title">Pengukuran Antropometri Berbasis Digital</h2>
      <h5 class="sub-title">Sistem Monitoring Status Gizi & Tumbuh Kembang Anak (Standar WHO)</h5>

      <div class="row">
        <div class="col-md-4">
          <div class="card card-custom p-4">
            <h5 class="mb-3">Data Anak</h5>
            <form id="antroForm">
              <div class="mb-3">
                <label class="form-label">Jenis Kelamin</label>
                <select class="form-select" id="jenisKelamin" required>
                  <option value="male">Laki-laki</option>
                  <option value="female">Perempuan</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Tanggal Lahir</label>
                <input type="date" class="form-control" id="tglLahir" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Tanggal Pengukuran</label>
                <input type="date" class="form-control" id="tglUkur" required>
              </div>
              
              <hr>
              
              <div class="mb-3">
                <label class="form-label">Berat Badan (kg)</label>
                <input type="number" step="0.01" class="form-control" id="beratBadan" placeholder="Contoh: 8.5" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Tinggi/Panjang Badan (cm)</label>
                <input type="number" step="0.1" class="form-control" id="tinggiBadan" placeholder="Contoh: 72.0" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Lingkar Kepala (cm)</label>
                <input type="number" step="0.1" class="form-control" id="lingkarKepala" placeholder="Contoh: 44.0">
              </div>
              <div class="mb-3">
                <label class="form-label">Lingkar Lengan Atas (cm)</label>
                <input type="number" step="0.1" class="form-control" id="lila" placeholder="Contoh: 13.5">
              </div>

              <button type="button" class="btn btn-primary w-100" onclick="hitungGizi()">Analisis Status Gizi</button>
              <button type="button" class="btn btn-secondary w-100 mt-2" onclick="exportPDF()">Ekspor Hasil ke PDF</button>
            </form>
          </div>
          
          <div id="hasilAnalisis" class="card card-custom p-4 d-none">
            <h5>Hasil Analisis</h5>
            <div class="result-box" id="statusStuntingBox"></div>
            <ul class="list-group mt-3 list-group-flush" id="detailList"></ul>
          </div>
        </div>

        <div class="col-md-8">
          <div class="row">
            <div class="col-md-12">
               <div class="card card-custom p-3">
                 <h6>Grafik Tinggi Badan per Umur (Indikator Stunting)</h6>
                 <div class="canvas-container"><canvas id="chartTBU"></canvas></div>
               </div>
            </div>
            <div class="col-md-6">
               <div class="card card-custom p-3">
                 <h6>Grafik Berat Badan per Umur</h6>
                 <div class="canvas-container"><canvas id="chartBBU"></canvas></div>
               </div>
            </div>
            <div class="col-md-6">
               <div class="card card-custom p-3">
                 <h6>Grafik BB per TB (Gizi Buruk/Gemuk)</h6>
                 <div class="canvas-container"><canvas id="chartBBTB"></canvas></div>
               </div>
            </div>
            <div class="col-md-6">
               <div class="card card-custom p-3">
                 <h6>Grafik IMT per Umur</h6>
                 <div class="canvas-container"><canvas id="chartIMT"></canvas></div>
               </div>
            </div>
             <div class="col-md-6">
               <div class="card card-custom p-3">
                 <h6>Grafik Lingkar Kepala</h6>
                 <div class="canvas-container"><canvas id="chartLK"></canvas></div>
               </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // --- DATA REFERENSI WHO (VERSI SIMPLIFIKASI UNTUK DEMO) ---
      // Data ini berisi titik-titik SD -3, -2, 0, +2, +3 untuk umur 0, 12, 24, 36, 48, 60 bulan.
      // Kode akan melakukan interpolasi linear di antara titik-titik ini.
      
      const WHO_REF = {
        male: {
          len: { // Panjang/Tinggi Badan (cm)
            0: [44.2, 46.1, 49.9, 53.7, 55.6],
            12: [68.6, 71.0, 75.7, 80.5, 82.9],
            24: [81.0, 83.2, 87.8, 92.4, 94.6],
            36: [88.7, 91.1, 96.1, 101.1, 103.5],
            48: [94.9, 97.6, 103.3, 108.7, 111.3],
            60: [100.7, 103.5, 110.0, 115.7, 118.4]
          },
          wei: { // Berat Badan (kg)
            0: [2.1, 2.5, 3.3, 4.2, 5.0],
            12: [7.7, 8.6, 9.6, 10.8, 12.0],
            24: [9.7, 10.8, 12.2, 13.6, 15.3],
            36: [11.3, 12.7, 14.3, 16.2, 18.3],
            48: [12.7, 14.4, 16.3, 18.6, 21.2],
            60: [14.1, 16.0, 18.3, 21.0, 24.2]
          },
          hc: { // Lingkar Kepala (cm)
            0: [31.9, 33.1, 34.5, 35.8, 37.0],
            12: [43.5, 44.7, 46.1, 47.4, 48.6],
            24: [46.3, 47.2, 48.3, 49.5, 50.5],
            36: [47.5, 48.4, 49.5, 50.8, 51.7],
            48: [48.2, 49.1, 50.2, 51.3, 52.2],
            60: [48.6, 49.5, 50.7, 51.9, 52.7]
          }
        },
        female: {
          len: {
            0: [43.6, 45.4, 49.1, 52.9, 54.7],
            12: [66.3, 68.9, 74.0, 79.2, 81.7],
            24: [79.3, 81.7, 86.4, 91.1, 93.5],
            36: [87.4, 90.0, 95.1, 100.1, 102.6],
            48: [94.1, 96.7, 102.3, 107.9, 110.6],
            60: [99.9, 102.7, 109.4, 115.4, 118.2]
          },
          wei: {
            0: [2.0, 2.4, 3.2, 4.0, 4.8],
            12: [7.0, 7.9, 8.9, 10.1, 11.5],
            24: [9.0, 10.2, 11.5, 13.0, 14.8],
            36: [10.8, 12.2, 13.9, 15.8, 18.1],
            48: [12.3, 14.0, 16.1, 18.5, 21.5],
            60: [13.7, 15.8, 18.2, 21.2, 24.9]
          },
          hc: {
            0: [31.5, 32.7, 33.9, 35.1, 36.2],
            12: [42.3, 43.5, 44.7, 46.0, 47.1],
            24: [45.1, 46.1, 47.2, 48.4, 49.4],
            36: [46.6, 47.5, 48.5, 49.8, 50.6],
            48: [47.4, 48.3, 49.4, 50.5, 51.3],
            60: [47.9, 48.9, 50.0, 51.1, 51.8]
          }
        }
      };

      // Variabel Global untuk Chart
      let charts = {};

      function hitungGizi() {
        // 1. Ambil Data
        const jk = document.getElementById('jenisKelamin').value;
        const tglLahir = new Date(document.getElementById('tglLahir').value);
        const tglUkur = new Date(document.getElementById('tglUkur').value);
        const bb = parseFloat(document.getElementById('beratBadan').value);
        const tb = parseFloat(document.getElementById('tinggiBadan').value);
        const lk = parseFloat(document.getElementById('lingkarKepala').value);
        const lila = parseFloat(document.getElementById('lila').value);

        if(isNaN(bb) || isNaN(tb) || !tglLahir || !tglUkur) {
          alert("Mohon lengkapi data berat, tinggi, dan tanggal.");
          return;
        }

        // 2. Hitung Umur (Bulan) - Lebih akurat
        let umurBulan = (tglUkur.getFullYear() - tglLahir.getFullYear()) * 12 + (tglUkur.getMonth() - tglLahir.getMonth());
        if (tglUkur.getDate() < tglLahir.getDate()) umurBulan--; // Koreksi hari
        
        if (umurBulan < 0 || umurBulan > 60) { alert("Umur harus antara 0-60 bulan."); return; }

        // 3. Hitung IMT
        const imt = bb / ((tb/100) * (tb/100));

        // 4. Analisis Sederhana
        const refTB = getReferenceData(jk, 'len', umurBulan);
        const refBB = getReferenceData(jk, 'wei', umurBulan);
        
        let statusStunting = "Normal";
        let statusClass = "normal";

        if (tb < refTB[1]) { 
          statusStunting = "STUNTING (Pendek)";
